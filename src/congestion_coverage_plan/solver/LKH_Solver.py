import subprocess
import os
import tempfile
import re

def solve_hamiltonian_path_with_lkh(matrix, vertices_ids, time_limit_seconds=5):
    lkh_path = "/usr/local/bin/lkh"
    dim = len(matrix)
    
    # Valore di sicurezza: abbastanza grande da essere evitato, 
    # ma abbastanza piccolo da non causare overflow (Max Int32 è ~2 miliardi)
    SAFE_INF = 100000000 

    with tempfile.TemporaryDirectory() as tmpdir:
        prob_file = os.path.join(tmpdir, "problem.atsp")
        out_file = os.path.join(tmpdir, "solution.txt")
        par_file = os.path.join(tmpdir, "params.par")

        # 1. Scrittura file ATSP con formattazione rigorosa
        with open(prob_file, "w") as f:
            f.write(f"NAME: Madama26\nTYPE: ATSP\nDIMENSION: {dim}\n")
            f.write("EDGE_WEIGHT_TYPE: EXPLICIT\n")
            f.write("EDGE_WEIGHT_FORMAT: FULL_MATRIX\n")
            f.write("EDGE_WEIGHT_SECTION\n")
            for row in matrix:
                clean_values = []
                for v in row:
                    # Se il valore è il tuo "infinito" originale o >= SAFE_INF
                    if v >= 999999999999:
                        clean_values.append(str(SAFE_INF))
                    else:
                        clean_values.append(str(int(v)))
                # Scriviamo i valori separati da spazio, una riga della matrice per riga di file
                f.write(" ".join(clean_values) + "\n")
            f.write("EOF\n")

        # 2. Parametri (aggiungiamo PRECISION per evitare arrotondamenti)
        with open(par_file, "w") as f:
            f.write(f"PROBLEM_FILE = {prob_file}\n")
            f.write(f"OUTPUT_TOUR_FILE = {out_file}\n")
            f.write("RUNS = 1\n")
            f.write(f"TIME_LIMIT = {time_limit_seconds}\n")

        # 3. Esecuzione
        try:
            result = subprocess.run([lkh_path, par_file], capture_output=True, text=True, check=True)
            
            # Debug: se il costo è ancora strano, guarda l'output grezzo di LKH
            # print(result.stdout) 

            # Cerchiamo il costo migliore trovato
            match = re.findall(r"Cost\s+=\s+(\d+)", result.stdout)
            raw_cost = int(match[-1]) if match else 0
        except Exception as e:
            print(f"Errore: {e}")
            return None, None

        # 4. Parsing Tour (rimane invariato)
        tour = []
        if os.path.exists(out_file):
            with open(out_file, "r") as f:
                content = f.readlines()
                is_tour = False
                for line in content:
                    if "TOUR_SECTION" in line: is_tour = True; continue
                    if "-1" in line or "EOF" in line: break
                    if is_tour: tour.append(int(line.strip()))

    # --- RICOSTRUZIONE COSTO REALE ---
    # Invece di fidarti del "Cost =" di LKH (che usa i valori SAFE_INF),
    # ricalcoliamo il costo usando la tua matrice originale.
    
    tour_indices = [i - 1 for i in tour]
    # Ruota rispetto al dummy (indice 0)
    z_pos = tour_indices.index(0)
    rotated = tour_indices[z_pos:] + tour_indices[:z_pos]
    
    real_total_cost = 0
    # Calcola la somma dei pesi degli archi nel percorso (escludendo i salti da/per il dummy)
    for i in range(1, len(rotated) - 1):
        from_node = rotated[i]
        to_node = rotated[i+1]
        real_total_cost += matrix[from_node][to_node]

    final_path = [vertices_ids[i] for i in rotated[1:]]
    return final_path, real_total_cost




def test():
    matrix = [[0, 0, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999],
            [9999999999999999, 0, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 427, 9999999999999999, 9999999999999999, 758, 9999999999999999, 9999999999999999, 1184, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 660, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999],
            [0, 9999999999999999, 0, 441, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 872, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 401, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 406, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999],
            [0, 9999999999999999, 441, 0, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 965, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 409, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 433, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999],
            [0, 9999999999999999, 9999999999999999, 9999999999999999, 0, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 1098, 753, 9999999999999999, 659, 9999999999999999, 9999999999999999, 358, 854, 9999999999999999, 9999999999999999, 9999999999999999, 679, 517, 1175, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999],
            [0, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 0, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 997, 731, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 737, 1468, 9999999999999999, 9999999999999999, 9999999999999999, 347, 1046, 1119, 1411, 9999999999999999, 9999999999999999],
            [0, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 0, 9999999999999999, 9999999999999999, 9999999999999999, 952, 754, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 502, 1373, 9999999999999999, 9999999999999999, 9999999999999999, 703, 534, 1327, 1058, 9999999999999999, 9999999999999999],
            [0, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 0, 9999999999999999, 9999999999999999, 9999999999999999, 1574, 9999999999999999, 702, 9999999999999999, 9999999999999999, 9999999999999999, 1003, 609, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 1037, 1492, 765, 268],
            [0, 9999999999999999, 872, 965, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 0, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 961, 564, 9999999999999999, 9999999999999999, 9999999999999999, 452, 1240, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 789, 524],
            [0, 427, 9999999999999999, 9999999999999999, 1098, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 0, 9999999999999999, 9999999999999999, 448, 9999999999999999, 9999999999999999, 874, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 595, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999],
            [0, 9999999999999999, 9999999999999999, 9999999999999999, 753, 997, 952, 9999999999999999, 9999999999999999, 9999999999999999, 0, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 452, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 650, 596, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999],
            [0, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 731, 754, 1574, 9999999999999999, 9999999999999999, 9999999999999999, 0, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 750, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 573, 713, 9999999999999999, 9999999999999999],
            [0, 758, 9999999999999999, 9999999999999999, 659, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 448, 9999999999999999, 9999999999999999, 0, 9999999999999999, 9999999999999999, 434, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 394, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999],
            [0, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 702, 961, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 0, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 579, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 338, 496],
            [0, 9999999999999999, 401, 409, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 564, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 0, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 697, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999],
            [0, 1184, 9999999999999999, 9999999999999999, 358, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 874, 9999999999999999, 9999999999999999, 434, 9999999999999999, 9999999999999999, 0, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 661, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999],
            [0, 9999999999999999, 9999999999999999, 9999999999999999, 854, 737, 502, 9999999999999999, 9999999999999999, 9999999999999999, 452, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 0, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 452, 337, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999],
            [0, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 1468, 1373, 1003, 9999999999999999, 9999999999999999, 9999999999999999, 750, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 0, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 553, 498, 9999999999999999, 9999999999999999],
            [0, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 609, 452, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 579, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 0, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 340, 368],
            [0, 9999999999999999, 406, 433, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 1240, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 697, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 0, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999],
            [0, 660, 9999999999999999, 9999999999999999, 679, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 595, 9999999999999999, 9999999999999999, 394, 9999999999999999, 9999999999999999, 661, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 0, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999],
            [0, 9999999999999999, 9999999999999999, 9999999999999999, 517, 347, 703, 9999999999999999, 9999999999999999, 9999999999999999, 650, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 452, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 0, 787, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999],
            [0, 9999999999999999, 9999999999999999, 9999999999999999, 1175, 1046, 534, 9999999999999999, 9999999999999999, 9999999999999999, 596, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 337, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 787, 0, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999],
            [0, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 1119, 1327, 1037, 9999999999999999, 9999999999999999, 9999999999999999, 573, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 553, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 0, 889, 9999999999999999, 9999999999999999],
            [0, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 1411, 1058, 1492, 9999999999999999, 9999999999999999, 9999999999999999, 713, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 498, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 889, 0, 9999999999999999, 9999999999999999],
            [0, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 765, 789, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 338, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 340, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 0, 499],
            [0, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 268, 524, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 496, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 368, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 9999999999999999, 499, 0]
    ]
    print(len(matrix))
    print(matrix[1][9])
    vertices_ids = ["fake", 'vertex1', 'vertex10', 'vertex11', 'vertex12', 'vertex13', 'vertex14', 'vertex15', 'vertex16', 'vertex17', 'vertex18', 'vertex19', 'vertex2', 'vertex20', 'vertex21', 'vertex22', 'vertex23', 'vertex24', 'vertex25', 'vertex26', 'vertex3', 'vertex4', 'vertex5', 'vertex6', 'vertex7', 'vertex8', 'vertex9']
    initial_vertex_id = "fake"
    path, cost = solve_hamiltonian_path_with_lkh(matrix, vertices_ids,10 )
    print("Percorso trovato:", path)
    print("Costo del percorso:", cost)

if __name__ == "__main__":
    test()